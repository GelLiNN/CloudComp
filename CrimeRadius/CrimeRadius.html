<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Crime in your vicinity!</title>
    <link href="QSstyle.css" type="text/css" rel="stylesheet" />
</head>
<body>
    <div id="main">
        <h1>Crime within inputted radius</h1>
        <input type="text" id="lat" size="20" placeholder="Latitude" />
        <input type="text" id="long" size="20" placeholder="Longitude" />
        <input type="text" id="rad" size="20" placeholder="Radius (Miles)" />
        <input type="submit" value="Get Crime!" onclick="makeJsonRequest()"></input>
        <p id="results">
        </p>
        <div id="crime_map" style="height: 500px; width: 500px;"></div>
    </div>
    <script src="https://code.jquery.com/jquery-2.1.4.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <script type="text/javascript">

    var gmap;
    function initMap() {
        gmap = new google.maps.Map(document.getElementById('crime_map'), {
            center: {lat: 47.51, lng: -122.25},
            zoom: 12
        });
        var geocoder = new google.maps.Geocoder();
        geocodeLocation(geocoder, gmap);
    }

    function geocodeLocation(geocoder, resultsMap) {

        var address = "Seattle, Washington";

        geocoder.geocode({'address': address}, function(results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                resultsMap.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                    map: resultsMap,
                    position: results[0].geometry.location
                });
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function makeJsonRequest() {
        var input_lat = document.getElementById('lat').value;
        var input_long = document.getElementById('long').value;
        var radius = parseInt(document.getElementById('rad').value);
        var radiusMeters = radius * 1609;
        //1609 Meters in a mile

        document.getElementById('results').innerHTML = "Latitude: " + input_lat +
            "\n" + "Longitude: " + input_long + "\n" + "Radius: " + radiusMeters;

            // inside the initMap function do the ajax call to get the data
            $.ajax({
                url: "https://data.seattle.gov/resource/pu5n-trf4.json",
                type: "GET",
                data: {
                    "$limit" : 50,
                    "$where" : "within_circle(incident_location, "
                        + input_lat + ", " + input_long + ", "+ radiusMeters + ")"
                }
            }).done(function(data) {
                alert("Retrieved " + data.length + " records from the dataset!");
                //console.log(data);
                console.log(data);
                document.getElementById('results').innerHTML = JSON.stringify(data);

                // Map the dates to a new array to make a histogram
                var map = data.map(function(index) {
                    if (index.event_clearance_date != null) {
                        return index.event_clearance_date;
                    } else {
                        return new Date();
                    }
                });
                console.log(map);

                $(data).each(function(index, value) {
                    //console.log(index);
                    //console.log(value.event_clearance_date);
                    geo
                    //instead of logging the date we could also
                    //parse the lat long from the JSON and plot it
                    //on Google maps using geocoding
                });

                /*var histogram = new d3.layout.histogram();
                    .bins(map.length)
                    (map)
                console.log(histogram);*/

            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDmoTS5rTt7cPjG3cJ38UpcAy7gDeZPSuI&callback=initMap"
    async defer></script>

</body>
</html>
